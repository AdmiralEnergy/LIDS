# COMPASS Fixes - Replit Implementation Prompt

## Audit Summary

The COMPASS feature branch (`Compassfeature`) has been reviewed. Here's what exists and what needs to be fixed:

### What's Working
- Agent sidebar with 6 FieldOps agents
- Chat interface with message bubbles and suggested actions
- Lead selector panel with toggle
- Enrich button calling `/api/enrichment/enrich`
- Enrichment summary display
- Agent avatars with status indicators
- Dark/light theme toggle
- Backend simulation for agent responses (keyword-based)
- Simulated property enrichment (not real Zillow data)

### Issues to Fix

| Issue | Severity | Current | Expected |
|-------|----------|---------|----------|
| Agent assignment | **CRITICAL** | Shows ALL 6 agents to every user | Rep sees ONLY their assigned agent |
| No user context | HIGH | No way to know which user is logged in | User selector or stored user identity |
| Hardcoded default | MEDIUM | `useState('fo-001')` in App.tsx | Use user's assigned agent |

---

## FIX 1: Add User Context (Required)

Since there's no auth system, add a simple user context that stores the current user in localStorage.

### Step 1: Create User Context

Create `client/src/lib/user-context.tsx`:

```tsx
import { createContext, useContext, useState, useEffect, ReactNode } from 'react';

// Demo users matching helm_registry
export interface User {
  id: string;
  name: string;
  email: string;
  role: 'owner' | 'manager' | 'rep';
  fieldops_agent_id: string;
}

export const DEMO_USERS: User[] = [
  { id: '1', name: 'David Edwards', email: 'davide@admiralenergy.ai', role: 'owner', fieldops_agent_id: 'fo-005' },
  { id: '2', name: 'Nate Jenkins', email: 'nathanielj@admiralenergy.ai', role: 'manager', fieldops_agent_id: 'fo-003' },
  { id: '3', name: 'Edwin Stewart', email: 'thesolardistrict@gmail.com', role: 'rep', fieldops_agent_id: 'fo-004' },
  { id: '4', name: 'Loie Hallug', email: 'info@thekardangroupltd.com', role: 'rep', fieldops_agent_id: 'fo-010' },
  { id: '5', name: 'Kareem Hallug', email: 'khallug@kardansolar.com', role: 'rep', fieldops_agent_id: 'fo-002' },
  { id: '6', name: 'Jonathan Lindqvist', email: 'lindqvist@logicside.co', role: 'rep', fieldops_agent_id: 'fo-001' },
];

interface UserContextType {
  currentUser: User | null;
  setCurrentUser: (user: User) => void;
  assignedAgentId: string;
}

const UserContext = createContext<UserContextType | undefined>(undefined);

const STORAGE_KEY = 'compass_current_user';

export function UserProvider({ children }: { children: ReactNode }) {
  const [currentUser, setCurrentUserState] = useState<User | null>(() => {
    const stored = localStorage.getItem(STORAGE_KEY);
    if (stored) {
      const parsed = JSON.parse(stored);
      return DEMO_USERS.find(u => u.id === parsed.id) || DEMO_USERS[0];
    }
    return DEMO_USERS[0]; // Default to first user
  });

  const setCurrentUser = (user: User) => {
    setCurrentUserState(user);
    localStorage.setItem(STORAGE_KEY, JSON.stringify({ id: user.id }));
  };

  const assignedAgentId = currentUser?.fieldops_agent_id || 'fo-001';

  return (
    <UserContext.Provider value={{ currentUser, setCurrentUser, assignedAgentId }}>
      {children}
    </UserContext.Provider>
  );
}

export function useUser() {
  const context = useContext(UserContext);
  if (!context) {
    throw new Error('useUser must be used within UserProvider');
  }
  return context;
}
```

### Step 2: Add User Selector Component

Create `client/src/components/UserSelector.tsx`:

```tsx
import { useUser, DEMO_USERS } from '@/lib/user-context';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
import { Button } from '@/components/ui/button';
import { User, ChevronDown } from 'lucide-react';

export function UserSelector() {
  const { currentUser, setCurrentUser } = useUser();

  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
        <Button variant="ghost" size="sm" className="gap-2">
          <User className="w-4 h-4" />
          <span className="max-w-32 truncate">{currentUser?.name || 'Select User'}</span>
          <ChevronDown className="w-3 h-3" />
        </Button>
      </DropdownMenuTrigger>
      <DropdownMenuContent align="end" className="w-56">
        <DropdownMenuLabel>Switch User (Demo)</DropdownMenuLabel>
        <DropdownMenuSeparator />
        {DEMO_USERS.map((user) => (
          <DropdownMenuItem
            key={user.id}
            onClick={() => setCurrentUser(user)}
            className={currentUser?.id === user.id ? 'bg-accent' : ''}
          >
            <div className="flex flex-col">
              <span className="font-medium">{user.name}</span>
              <span className="text-xs text-muted-foreground">
                {user.fieldops_agent_id.toUpperCase()} | {user.role}
              </span>
            </div>
          </DropdownMenuItem>
        ))}
      </DropdownMenuContent>
    </DropdownMenu>
  );
}
```

---

## FIX 2: Update App.tsx to Use User Context

Replace the current `App.tsx` with:

```tsx
import { Switch, Route } from "wouter";
import { queryClient } from "./lib/queryClient";
import { QueryClientProvider } from "@tanstack/react-query";
import { Toaster } from "@/components/ui/toaster";
import { TooltipProvider } from "@/components/ui/tooltip";
import { SidebarProvider, SidebarTrigger } from "@/components/ui/sidebar";
import { AgentSidebar } from "@/components/compass/AgentSidebar";
import { ThemeToggle } from "@/components/ThemeToggle";
import { UserSelector } from "@/components/UserSelector";
import { UserProvider, useUser } from "@/lib/user-context";
import Home from "@/pages/home";
import NotFound from "@/pages/not-found";

function Router() {
  const { assignedAgentId } = useUser();

  return (
    <Switch>
      <Route path="/">
        <Home selectedAgentId={assignedAgentId} />
      </Route>
      <Route component={NotFound} />
    </Switch>
  );
}

function AppLayout() {
  const { assignedAgentId } = useUser();

  const style = {
    "--sidebar-width": "18rem",
    "--sidebar-width-icon": "4rem",
  };

  return (
    <SidebarProvider style={style as React.CSSProperties}>
      <div className="flex h-screen w-full">
        <AgentSidebar agentId={assignedAgentId} />
        <div className="flex flex-col flex-1 min-w-0">
          <header className="h-12 border-b border-border flex items-center gap-2 px-3 flex-shrink-0 bg-background">
            <SidebarTrigger data-testid="button-sidebar-toggle" />
            <div className="flex-1" />
            <UserSelector />
            <ThemeToggle />
          </header>
          <main className="flex-1 overflow-hidden">
            <Router />
          </main>
        </div>
      </div>
    </SidebarProvider>
  );
}

function App() {
  return (
    <QueryClientProvider client={queryClient}>
      <TooltipProvider>
        <UserProvider>
          <Toaster />
          <AppLayout />
        </UserProvider>
      </TooltipProvider>
    </QueryClientProvider>
  );
}

export default App;
```

**Key Changes:**
1. Wrapped app in `UserProvider`
2. Removed `selectedAgentId` state - now comes from `useUser().assignedAgentId`
3. Added `UserSelector` to header
4. Changed `AgentSidebar` props from selection mode to single-agent mode

---

## FIX 3: Simplify AgentSidebar to Show ONLY Assigned Agent

Replace `client/src/components/compass/AgentSidebar.tsx`:

```tsx
import {
  Sidebar,
  SidebarContent,
  SidebarGroup,
  SidebarGroupContent,
  SidebarGroupLabel,
  SidebarHeader,
  SidebarFooter,
} from "@/components/ui/sidebar";
import { AgentAvatar } from "./AgentAvatar";
import { getAgent, type AgentInfo } from "@/lib/compass/agents";
import { Compass, Settings, HelpCircle } from "lucide-react";
import { Button } from "@/components/ui/button";
import { useUser } from "@/lib/user-context";

interface AgentSidebarProps {
  agentId: string;
}

const statusLabels = {
  online: 'Online',
  away: 'Away',
  busy: 'Busy',
  offline: 'Offline',
};

export function AgentSidebar({ agentId }: AgentSidebarProps) {
  const { currentUser } = useUser();
  const agent = getAgent(agentId);

  if (!agent) {
    return null;
  }

  return (
    <Sidebar>
      <SidebarHeader className="p-4 border-b border-sidebar-border">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 rounded-md bg-gradient-to-br from-primary to-chart-1 flex items-center justify-center">
            <Compass className="w-5 h-5 text-primary-foreground" />
          </div>
          <div>
            <h1 className="font-bold text-lg text-sidebar-foreground tracking-tight">COMPASS</h1>
            <p className="text-xs text-sidebar-foreground/60">AI Sales Assistant</p>
          </div>
        </div>
      </SidebarHeader>

      <SidebarContent>
        <SidebarGroup>
          <SidebarGroupLabel className="text-xs font-medium uppercase tracking-wider text-sidebar-foreground/50">
            Your Agent Partner
          </SidebarGroupLabel>
          <SidebarGroupContent>
            {/* Single Agent Display - Not a List */}
            <div className="p-4">
              <div className="flex flex-col items-center text-center gap-4">
                <AgentAvatar agentId={agent.id} size="lg" showStatus />
                <div>
                  <h2 className="font-bold text-xl" style={{ color: agent.color }}>
                    {agent.name}
                  </h2>
                  <p className="text-sm text-sidebar-foreground/60 mt-1">
                    {agent.description}
                  </p>
                  <div className="mt-2 flex items-center justify-center gap-2">
                    <span className={`w-2 h-2 rounded-full ${
                      agent.status === 'online' ? 'bg-green-500' :
                      agent.status === 'away' ? 'bg-yellow-500' :
                      agent.status === 'busy' ? 'bg-red-500' : 'bg-gray-500'
                    }`} />
                    <span className="text-xs text-sidebar-foreground/60">
                      {statusLabels[agent.status]}
                    </span>
                  </div>
                </div>
              </div>

              {/* Agent Stats */}
              <div className="mt-6 grid grid-cols-2 gap-3">
                <div className="p-3 rounded-lg bg-sidebar-accent/50 text-center">
                  <div className="text-2xl font-bold text-sidebar-foreground">24</div>
                  <div className="text-xs text-sidebar-foreground/60">Leads Enriched</div>
                </div>
                <div className="p-3 rounded-lg bg-sidebar-accent/50 text-center">
                  <div className="text-2xl font-bold text-sidebar-foreground">156</div>
                  <div className="text-xs text-sidebar-foreground/60">Messages Today</div>
                </div>
              </div>
            </div>
          </SidebarGroupContent>
        </SidebarGroup>

        {/* Quick Actions */}
        <SidebarGroup>
          <SidebarGroupLabel className="text-xs font-medium uppercase tracking-wider text-sidebar-foreground/50">
            Quick Actions
          </SidebarGroupLabel>
          <SidebarGroupContent className="px-4 space-y-2">
            <Button variant="outline" className="w-full justify-start gap-2" size="sm">
              Enrich Top Leads
            </Button>
            <Button variant="outline" className="w-full justify-start gap-2" size="sm">
              Pipeline Summary
            </Button>
            <Button variant="outline" className="w-full justify-start gap-2" size="sm">
              Daily Briefing
            </Button>
          </SidebarGroupContent>
        </SidebarGroup>
      </SidebarContent>

      <SidebarFooter className="p-4 border-t border-sidebar-border">
        <div className="text-xs text-sidebar-foreground/40 mb-2">
          Logged in as: {currentUser?.name}
        </div>
        <div className="flex items-center gap-2">
          <Button
            variant="ghost"
            size="icon"
            className="text-sidebar-foreground/60"
          >
            <Settings className="w-4 h-4" />
          </Button>
          <Button
            variant="ghost"
            size="icon"
            className="text-sidebar-foreground/60"
          >
            <HelpCircle className="w-4 h-4" />
          </Button>
          <div className="flex-1" />
          <span className="text-xs text-sidebar-foreground/40">v1.0.0</span>
        </div>
      </SidebarFooter>
    </Sidebar>
  );
}
```

**Key Changes:**
1. Now takes `agentId` prop instead of `selectedAgentId` + `onSelectAgent`
2. Shows ONLY the single assigned agent (no list, no selection)
3. Displays agent prominently with avatar, name, description, status
4. Added placeholder stats and quick actions
5. Shows current user name in footer

---

## FIX 4: Update Home Page Props

Update `client/src/pages/home.tsx` to remove agent selection logic:

The `selectedAgentId` prop is now passed directly from App.tsx (from user context), so no changes needed to the props interface. Just ensure it uses the prop correctly.

---

## Summary of Files to Change

| File | Action | Description |
|------|--------|-------------|
| `client/src/lib/user-context.tsx` | **CREATE** | User context with demo users and localStorage |
| `client/src/components/UserSelector.tsx` | **CREATE** | Dropdown to switch demo users |
| `client/src/App.tsx` | **REPLACE** | Add UserProvider, use context for agent ID |
| `client/src/components/compass/AgentSidebar.tsx` | **REPLACE** | Single agent view, not a list |

---

## Testing

1. Open the app
2. Check sidebar shows ONLY one agent (not a list of 6)
3. Use the user selector dropdown in the header
4. Switch to different users
5. Verify sidebar shows their assigned agent:
   - David Edwards → WATCHMAN (fo-005)
   - Nate Jenkins → CALLER (fo-003)
   - Edwin Stewart → SCRIBE (fo-004)
   - Loie Hallug → APEX (fo-010)
   - Kareem Hallug → ANALYST (fo-002)
   - Jonathan Lindqvist → SCOUT (fo-001)

---

## Future Enhancements (Not Required Now)

1. **Real Auth Integration** - When ready, replace DEMO_USERS with API call to helm_registry
2. **Zillow Enrichment** - Replace simulated data with real scraping
3. **LLM Integration** - Replace keyword matching with actual Claude API calls
4. **Role-Based Views** - Owners see all agents, managers see team agents
