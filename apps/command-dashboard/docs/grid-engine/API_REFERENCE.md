# Grid Engine API Reference

**Complete REST API documentation for NC Duke Grid Readiness Engine.**

**Base URL:** `http://193.122.153.249:4120`

---

## Health & Status

### GET /health

Basic health check for load balancers and monitoring.

**Response:**
```json
{
  "status": "ok",
  "version": "1.0.0",
  "uptime": 86400
}
```

---

### GET /status

Comprehensive system status including all feeds, county states, and subscribers.

**Response:**
```json
{
  "feeds": [
    {
      "source": "NWS",
      "lastSuccessAt": "2026-01-03T14:30:00Z",
      "isStale": false,
      "lastError": null
    },
    {
      "source": "DUKE_DEC",
      "lastSuccessAt": "2026-01-03T14:30:00Z",
      "isStale": false,
      "lastError": null
    },
    {
      "source": "DUKE_DEP",
      "lastSuccessAt": "2026-01-03T14:30:00Z",
      "isStale": false,
      "lastError": null
    }
  ],
  "countyStates": [
    {
      "county": "Cleveland",
      "level": "GREEN",
      "reason": "No active alerts or outages",
      "customersOut": 0,
      "percentOut": 0,
      "nwsAlerts": []
    },
    {
      "county": "Wake",
      "level": "BLACK",
      "reason": "Active outage: 2,150 customers affected",
      "customersOut": 2150,
      "percentOut": 0.21,
      "nwsAlerts": ["Severe Thunderstorm Warning"]
    }
  ],
  "subscribers": {
    "total": 127,
    "byCounty": {
      "Wake": 45,
      "Durham": 32,
      "Cleveland": 12
    }
  },
  "safeMode": "NORMAL"
}
```

**Safe Mode Values:**
- `NORMAL` - All feeds fresh, full alerting enabled
- `DUKE_STALE` - Duke data >15 min old, BLACK alerts suppressed
- `NWS_STALE` - NWS data >20 min old, YELLOW/RED alerts suppressed
- `FULL_SAFE` - Both stale, no alerts sent

---

## County Data

### GET /api/counties

Get current status of all 100 NC counties.

**Response:**
```json
{
  "counties": [
    {
      "name": "Alamance",
      "fips": "37001",
      "level": "GREEN",
      "reason": "No active alerts or outages",
      "customersOut": 0,
      "percentOut": 0,
      "population": 164521,
      "lastUpdated": "2026-01-03T14:30:00Z"
    },
    {
      "name": "Cleveland",
      "fips": "37045",
      "level": "GREEN",
      "reason": "No active alerts or outages",
      "customersOut": 0,
      "percentOut": 0,
      "population": 99519,
      "lastUpdated": "2026-01-03T14:30:00Z"
    }
  ],
  "summary": {
    "green": 97,
    "yellow": 2,
    "red": 0,
    "black": 1
  }
}
```

---

### GET /api/counties/:name

Get detailed status for a specific county.

**Parameters:**
- `name` (path) - County name, case-insensitive

**Example:** `GET /api/counties/Cleveland`

**Response:**
```json
{
  "name": "Cleveland",
  "fips": "37045",
  "level": "GREEN",
  "reason": "No active alerts or outages",
  "customersOut": 0,
  "percentOut": 0,
  "population": 99519,
  "blackThreshold": 995,
  "vulnerabilityWeight": 0.7,
  "lastUpdated": "2026-01-03T14:30:00Z",
  "activeAlerts": [],
  "recentHistory": [
    {
      "fromLevel": "YELLOW",
      "toLevel": "GREEN",
      "reason": "Weather alert expired",
      "timestamp": "2026-01-02T18:00:00Z"
    }
  ]
}
```

**Error Response (404):**
```json
{
  "error": "County not found",
  "validCounties": ["Alamance", "Alexander", "Alleghany", "..."]
}
```

---

### POST /api/counties/:name/vulnerability

Set the vulnerability weight for a county. Higher weight = more likely to trigger YELLOW alerts.

**Parameters:**
- `name` (path) - County name

**Body:**
```json
{
  "weight": 0.8
}
```

**Constraints:**
- `weight` must be between 0.0 and 1.0

**Response:**
```json
{
  "success": true,
  "county": "Cleveland",
  "weight": 0.8,
  "previousWeight": 0.5
}
```

---

## Weather Alerts

### GET /api/alerts/active

Get all active NWS weather alerts affecting NC.

**Response:**
```json
{
  "alerts": [
    {
      "id": "urn:oid:2.49.0.1.840.0.abc123",
      "event": "Severe Thunderstorm Warning",
      "severity": "Severe",
      "certainty": "Observed",
      "urgency": "Immediate",
      "headline": "Severe Thunderstorm Warning issued January 3 at 2:30 PM EST",
      "areaDesc": "Wake; Durham; Orange",
      "affectedCounties": ["Wake", "Durham", "Orange"],
      "onset": "2026-01-03T14:30:00-05:00",
      "expires": "2026-01-03T15:30:00-05:00"
    }
  ],
  "count": 1,
  "lastUpdated": "2026-01-03T14:30:00Z"
}
```

---

### GET /api/alerts/recent

Get recent state transitions generated by the system.

**Query Parameters:**
- `limit` (optional) - Number of alerts to return (default: 50, max: 200)
- `county` (optional) - Filter by county name

**Example:** `GET /api/alerts/recent?limit=10&county=Cleveland`

**Response:**
```json
{
  "alerts": [
    {
      "id": 1234,
      "county": "Cleveland",
      "fromLevel": "GREEN",
      "toLevel": "YELLOW",
      "reason": "2-of-3 confirmation: NWS alert + vulnerability + severe weather type",
      "timestamp": "2026-01-02T14:00:00Z"
    },
    {
      "id": 1235,
      "county": "Cleveland",
      "fromLevel": "YELLOW",
      "toLevel": "GREEN",
      "reason": "Weather alert expired",
      "timestamp": "2026-01-02T18:00:00Z"
    }
  ],
  "count": 2
}
```

---

## Power Outages

### GET /api/outages/current

Get current power outage data aggregated by county.

**Response:**
```json
{
  "counties": {
    "Wake": 2150,
    "Macon": 96,
    "Buncombe": 45
  },
  "totalCountiesAffected": 3,
  "totalCustomersAffected": 2291,
  "lastUpdated": "2026-01-03T14:30:00Z",
  "sources": {
    "DEC": {
      "outagePoints": 12,
      "customersAffected": 1800
    },
    "DEP": {
      "outagePoints": 5,
      "customersAffected": 491
    }
  }
}
```

---

### GET /api/outages/history

Get historical outage data.

**Query Parameters:**
- `county` (optional) - Filter by county
- `since` (optional) - ISO 8601 timestamp
- `limit` (optional) - Number of records (default: 100)

**Response:**
```json
{
  "records": [
    {
      "county": "Wake",
      "customersOut": 2150,
      "percentOut": 0.21,
      "timestamp": "2026-01-03T14:30:00Z"
    }
  ],
  "count": 1
}
```

---

## Subscribers

### GET /api/subscribers/stats

Get subscriber statistics (no PII).

**Response:**
```json
{
  "total": 127,
  "verified": 98,
  "byCounty": {
    "Wake": 45,
    "Durham": 32,
    "Orange": 18,
    "Cleveland": 12,
    "Mecklenburg": 20
  }
}
```

---

### POST /api/subscribe

Register a new subscriber for SMS alerts.

**Body:**
```json
{
  "phone": "+19195551234",
  "counties": ["Cleveland", "Gaston", "Lincoln"]
}
```

**Constraints:**
- `phone` must be valid E.164 format
- `counties` must be valid NC county names

**Response:**
```json
{
  "success": true,
  "id": 128,
  "phone": "+19195551234",
  "counties": ["Cleveland", "Gaston", "Lincoln"],
  "status": "pending_verification"
}
```

---

### DELETE /api/subscribers/:phone

Unsubscribe a phone number.

**Response:**
```json
{
  "success": true,
  "message": "Subscriber removed"
}
```

---

## Admin Operations

### POST /api/refresh

Trigger an immediate data refresh from all sources.

**Response:**
```json
{
  "success": true,
  "message": "Refresh triggered",
  "results": {
    "nws": { "success": true, "alertCount": 3 },
    "duke_dec": { "success": true, "outagePoints": 12 },
    "duke_dep": { "success": true, "outagePoints": 5 }
  }
}
```

---

### POST /admin/safe-mode

Force the system into a specific safe mode.

**Body:**
```json
{
  "mode": "FULL_SAFE"
}
```

**Valid Modes:** `NORMAL`, `DUKE_STALE`, `NWS_STALE`, `FULL_SAFE`

**Response:**
```json
{
  "success": true,
  "previousMode": "NORMAL",
  "newMode": "FULL_SAFE",
  "message": "All alerting disabled"
}
```

---

### POST /admin/reset-county/:name

Reset a county to GREEN state (for testing/recovery).

**Response:**
```json
{
  "success": true,
  "county": "Cleveland",
  "previousLevel": "YELLOW",
  "newLevel": "GREEN"
}
```

---

## Error Responses

All errors follow this format:

```json
{
  "error": "Error message",
  "code": "ERROR_CODE",
  "details": {}
}
```

**Common Error Codes:**

| Code | HTTP Status | Meaning |
|------|-------------|---------|
| `COUNTY_NOT_FOUND` | 404 | Invalid county name |
| `INVALID_PHONE` | 400 | Phone number not in E.164 format |
| `INVALID_WEIGHT` | 400 | Vulnerability weight out of range |
| `FEED_ERROR` | 503 | External API (NWS/Duke) unavailable |
| `INTERNAL_ERROR` | 500 | Server error |

---

## Rate Limits

No rate limits are currently enforced. The system is designed for internal use only.

If exposed publicly, implement:
- 100 requests/minute for GET endpoints
- 10 requests/minute for POST endpoints

---

*See also: [ARCHITECTURE.md](./ARCHITECTURE.md) | [STATE_MACHINE.md](./STATE_MACHINE.md)*
